
<!DOCTYPE html>

<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="generator" content="Docutils 0.19: https://docutils.sourceforge.io/" />

    <title>Chapter 2: Flat Vectors of Strings &#8212; Velox  documentation</title>
    <link rel="stylesheet" type="text/css" href="../_static/pygments.css" />
    <link rel="stylesheet" type="text/css" href="../_static/nature.css" />
    <script data-url_root="../" id="documentation_options" src="../_static/documentation_options.js"></script>
    <script src="../_static/doctools.js"></script>
    <script src="../_static/sphinx_highlight.js"></script>
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
    <link rel="prev" title="Chapter 1: Buffers and Flat Vectors" href="chapter01.html" /> 
  </head><body>
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../genindex.html" title="General Index"
             accesskey="I">index</a></li>
        <li class="right" >
          <a href="chapter01.html" title="Chapter 1: Buffers and Flat Vectors"
             accesskey="P">previous</a> |</li>
        <li class="nav-item nav-item-0"><a href="../index.html">Velox  documentation</a> &#187;</li>
          <li class="nav-item nav-item-1"><a href="../programming-guide.html" accesskey="U">Programming Guide</a> &#187;</li>
        <li class="nav-item nav-item-this"><a href="">Chapter 2: Flat Vectors of Strings</a></li> 
      </ul>
    </div>  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body" role="main">
            
  <section id="chapter-2-flat-vectors-of-strings">
<h1>Chapter 2: Flat Vectors of Strings<a class="headerlink" href="#chapter-2-flat-vectors-of-strings" title="Permalink to this heading">¶</a></h1>
<p>In <a class="reference internal" href="chapter01.html"><span class="doc">Chapter 1</span></a> we learned how to allocate
buffers to store integer values and null flags and how to create flat vectors
from these buffers. In this chapter we will look into creating flat vectors of
strings.</p>
<p>Unlike integer values, string values have variable sizes. One string can be 10
characters long, another 20 characters long. In Velox, strings are represented
using StringView structs. Each StringView is 16 bytes long. 4 bytes store the
length of the string. The remaining 12 bytes store either the string itself, if
it fits, or 4-byte prefix of the string followed by 8-byte pointer to the string
located in a separate buffer.</p>
<div class="highlight-c++ notranslate"><div class="highlight"><pre><span></span><span class="k">struct</span><span class="w"> </span><span class="nc">StringView</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="kt">uint32_t</span><span class="w"> </span><span class="n">size_</span><span class="p">;</span>
<span class="w">    </span><span class="kt">char</span><span class="w"> </span><span class="n">prefix_</span><span class="p">[</span><span class="mi">4</span><span class="p">];</span>
<span class="w">    </span><span class="k">union</span><span class="w"> </span><span class="p">{</span>
<span class="w">     </span><span class="kt">char</span><span class="w"> </span><span class="n">inlined</span><span class="p">[</span><span class="mi">8</span><span class="p">];</span>
<span class="w">     </span><span class="k">const</span><span class="w"> </span><span class="kt">char</span><span class="o">*</span><span class="w"> </span><span class="n">data</span><span class="p">;</span>
<span class="w">    </span><span class="p">}</span><span class="w"> </span><span class="n">value_</span><span class="p">;</span>
<span class="p">}</span>
</pre></div>
</div>
<p>Strings that are 12 bytes or shorter are referred to as inline strings. These
strings are fully stored within the StringView struct.</p>
<p>Flat vector of strings has values buffer that stores StringViews, nulls buffer,
and zero or more string buffers. String buffers store strings longer than 12
bytes. Strings in string buffers can appear in any order. String buffers may
contain more data than is used by the vector.</p>
<p>Let’s create a vector of strings. First, allocate a values buffer to hold 100
StringViews and initialize them to empty strings. Then, form a
FlatVector&lt;StingView&gt; around that values buffer.</p>
<div class="highlight-c++ notranslate"><div class="highlight"><pre><span></span><span class="cp">#include</span><span class="w"> </span><span class="cpf">&quot;velox/vector/FlatVector.h&quot;</span>

<span class="n">BufferPtr</span><span class="w"> </span><span class="n">values</span><span class="w"> </span><span class="o">=</span>
<span class="w">   </span><span class="n">AlignedBuffer</span><span class="o">::</span><span class="n">allocate</span><span class="o">&lt;</span><span class="n">StringView</span><span class="o">&gt;</span><span class="p">(</span><span class="mi">100</span><span class="p">,</span><span class="w"> </span><span class="n">pool</span><span class="p">.</span><span class="n">get</span><span class="p">(),</span><span class="w"> </span><span class="n">StringView</span><span class="p">());</span>
<span class="k">auto</span><span class="w"> </span><span class="n">vector</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">make_shared</span><span class="o">&lt;</span><span class="n">FlatVector</span><span class="o">&lt;</span><span class="n">StringView</span><span class="o">&gt;&gt;</span><span class="p">(</span>
<span class="w">   </span><span class="n">pool</span><span class="p">.</span><span class="n">get</span><span class="p">(),</span><span class="w"> </span><span class="n">VARCHAR</span><span class="p">(),</span><span class="w"> </span><span class="k">nullptr</span><span class="p">,</span><span class="w"> </span><span class="mi">100</span><span class="p">,</span><span class="w"> </span><span class="n">values</span><span class="p">,</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">vector</span><span class="o">&lt;</span><span class="n">BufferPtr</span><span class="o">&gt;</span><span class="p">{});</span>

<span class="n">LOG</span><span class="p">(</span><span class="n">INFO</span><span class="p">)</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="n">vector</span><span class="o">-&gt;</span><span class="n">toString</span><span class="p">();</span>

<span class="o">&gt;</span><span class="w"> </span><span class="p">[</span><span class="n">FLAT</span><span class="w"> </span><span class="n">VARCHAR</span><span class="o">:</span><span class="w"> </span><span class="mi">100</span><span class="w"> </span><span class="n">elements</span><span class="p">,</span><span class="w"> </span><span class="n">no</span><span class="w"> </span><span class="n">nulls</span><span class="p">]</span>
</pre></div>
</div>
<p>Note that values buffers that hold strings must be initialized explicitly,
otherwise 4 bytes that are supposed to store the length of a string will
contain garbage values and accessing StringView with such sizes will lead to
failures or crashes.</p>
<p>Let’s see what happens if we forget to initialize the StringView buffer, i.e.
do not pass StringView() 3-rd argument to AlignedBuffer::allocate.</p>
<div class="highlight-c++ notranslate"><div class="highlight"><pre><span></span><span class="c1">// Danger!!! Creating a buffer with uninitialized content.</span>
<span class="n">BufferPtr</span><span class="w"> </span><span class="n">values</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">AlignedBuffer</span><span class="o">::</span><span class="n">allocate</span><span class="o">&lt;</span><span class="n">StringView</span><span class="o">&gt;</span><span class="p">(</span><span class="mi">100</span><span class="p">,</span><span class="w"> </span><span class="n">pool</span><span class="p">.</span><span class="n">get</span><span class="p">());</span>
<span class="k">auto</span><span class="w"> </span><span class="n">vector</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">make_shared</span><span class="o">&lt;</span><span class="n">FlatVector</span><span class="o">&lt;</span><span class="n">StringView</span><span class="o">&gt;&gt;</span><span class="p">(</span>
<span class="w">   </span><span class="n">pool</span><span class="p">.</span><span class="n">get</span><span class="p">(),</span><span class="w"> </span><span class="n">VARCHAR</span><span class="p">(),</span><span class="w"> </span><span class="k">nullptr</span><span class="p">,</span><span class="w"> </span><span class="mi">100</span><span class="p">,</span><span class="w"> </span><span class="n">values</span><span class="p">,</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">vector</span><span class="o">&lt;</span><span class="n">BufferPtr</span><span class="o">&gt;</span><span class="p">{});</span>

<span class="n">LOG</span><span class="p">(</span><span class="n">INFO</span><span class="p">)</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="n">vector</span><span class="o">-&gt;</span><span class="n">toString</span><span class="p">();</span>
<span class="n">LOG</span><span class="p">(</span><span class="n">INFO</span><span class="p">)</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="s">&quot;Size of the string in row 5: &quot;</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="n">vector</span><span class="o">-&gt;</span><span class="n">valueAt</span><span class="p">(</span><span class="mi">5</span><span class="p">).</span><span class="n">size</span><span class="p">();</span>
<span class="n">LOG</span><span class="p">(</span><span class="n">INFO</span><span class="p">)</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="n">vector</span><span class="o">-&gt;</span><span class="n">toString</span><span class="p">(</span><span class="mi">5</span><span class="p">);</span>

<span class="o">&gt;</span><span class="w"> </span><span class="p">[</span><span class="n">FLAT</span><span class="w"> </span><span class="n">VARCHAR</span><span class="o">:</span><span class="w"> </span><span class="mi">100</span><span class="w"> </span><span class="n">elements</span><span class="p">,</span><span class="w"> </span><span class="n">no</span><span class="w"> </span><span class="n">nulls</span><span class="p">]</span>
<span class="o">&gt;</span><span class="w"> </span><span class="n">Size</span><span class="w"> </span><span class="n">of</span><span class="w"> </span><span class="n">the</span><span class="w"> </span><span class="n">string</span><span class="w"> </span><span class="n">in</span><span class="w"> </span><span class="n">row</span><span class="w"> </span><span class="mi">5</span><span class="o">:</span><span class="w"> </span><span class="mi">2711724449</span>
<span class="n">Process</span><span class="w"> </span><span class="n">finished</span><span class="w"> </span><span class="n">with</span><span class="w"> </span><span class="n">exit</span><span class="w"> </span><span class="n">code</span><span class="w"> </span><span class="mi">139</span><span class="w"> </span><span class="p">(</span><span class="n">interrupted</span><span class="w"> </span><span class="n">by</span><span class="w"> </span><span class="n">signal</span><span class="w"> </span><span class="mi">11</span><span class="o">:</span><span class="w"> </span><span class="n">SIGSEGV</span><span class="p">)</span>
</pre></div>
</div>
<p>The process crashed trying to print a string of size 2711724449. No surprise.</p>
<p>If we run this code under ASAN, we get an ERROR: AddressSanitizer: unknown-crash.</p>
<div class="highlight-c++ notranslate"><div class="highlight"><pre><span></span><span class="o">&gt;</span><span class="w"> </span><span class="p">[</span><span class="n">FLAT</span><span class="w"> </span><span class="n">VARCHAR</span><span class="o">:</span><span class="w"> </span><span class="mi">100</span><span class="w"> </span><span class="n">elements</span><span class="p">,</span><span class="w"> </span><span class="n">no</span><span class="w"> </span><span class="n">nulls</span><span class="p">]</span>
<span class="o">&gt;</span><span class="w"> </span><span class="n">Size</span><span class="w"> </span><span class="n">of</span><span class="w"> </span><span class="n">the</span><span class="w"> </span><span class="n">string</span><span class="w"> </span><span class="n">in</span><span class="w"> </span><span class="n">row</span><span class="w"> </span><span class="mi">5</span><span class="o">:</span><span class="w"> </span><span class="mi">2711724449</span>

<span class="o">=================================================================</span>
<span class="o">==</span><span class="mi">1753639</span><span class="o">==</span><span class="n">ERROR</span><span class="o">:</span><span class="w"> </span><span class="n">AddressSanitizer</span><span class="o">:</span><span class="w"> </span><span class="n">unknown</span><span class="o">-</span><span class="n">crash</span><span class="w"> </span><span class="n">on</span><span class="w"> </span><span class="n">address</span><span class="w"> </span><span class="mh">0xa1a1a1a1a1a1a1a1</span><span class="w"> </span><span class="n">at</span><span class="w"> </span><span class="n">pc</span><span class="w"> </span><span class="mh">0x00000125c2c2</span><span class="w"> </span><span class="n">bp</span><span class="w"> </span><span class="mh">0x7fff780d6050</span><span class="w"> </span><span class="n">sp</span><span class="w"> </span><span class="mh">0x7fff780d5810</span>
<span class="n">READ</span><span class="w"> </span><span class="n">of</span><span class="w"> </span><span class="n">size</span><span class="w"> </span><span class="mi">2711724449</span><span class="w"> </span><span class="n">at</span><span class="w"> </span><span class="mh">0xa1a1a1a1a1a1a1a1</span><span class="w"> </span><span class="kr">thread</span><span class="w"> </span><span class="n">T0</span>
<span class="nl">SCARINESS</span><span class="p">:</span><span class="w"> </span><span class="mi">16</span><span class="w"> </span><span class="p">(</span><span class="n">multi</span><span class="o">-</span><span class="n">byte</span><span class="o">-</span><span class="n">read</span><span class="p">)</span>
<span class="cp">#0 0x125c2c1 in __asan_memcpy</span>
<span class="cp">#1 0x5fc750 in std::char_traits&lt;char&gt;::copy(char*, char const*, unsigned long) libgcc/include/c++/trunk/bits/char_traits.h:409</span>
<span class="cp">#2 0x5fc661 in std::__cxx11::basic_string&lt;char, std::char_traits&lt;char&gt;, std::allocator&lt;char&gt;&gt;::_S_copy(char*, char const*, unsigned long) libgcc/include/c++/trunk/bits/basic_string.h:359</span>
<span class="cp">#3 0x5fc177 in std::__cxx11::basic_string&lt;char, std::char_traits&lt;char&gt;, std::allocator&lt;char&gt;&gt;::_S_copy_chars(char*, char const*, char const*) libgcc/include/c++/trunk/bits/basic_string.h:406</span>
<span class="p">...</span>
<span class="cp">#9 0x9764c7 in facebook::velox::SimpleVector&lt;facebook::velox::StringView&gt;::valueToString[abi:cxx11](facebook::velox::StringView) const vector/SimpleVector.h:195</span>
<span class="cp">#10 0x93f05c in facebook::velox::SimpleVector&lt;facebook::velox::StringView&gt;::toString[abi:cxx11](int) const vector/SimpleVector.h:205</span>
</pre></div>
</div>
<p>We can also use BaseVector::create static method to make a vector. This method
is preferred because it requires less code and it makes sure that the values
buffer has the right size and is initialized properly.</p>
<div class="highlight-c++ notranslate"><div class="highlight"><pre><span></span><span class="cp">#include</span><span class="w"> </span><span class="cpf">&quot;velox/vector/FlatVector.h&quot;</span>

<span class="k">auto</span><span class="w"> </span><span class="n">vector</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">BaseVector</span><span class="o">::</span><span class="n">create</span><span class="p">(</span><span class="n">VARCHAR</span><span class="p">(),</span><span class="w"> </span><span class="mi">100</span><span class="p">,</span><span class="w"> </span><span class="n">pool</span><span class="p">.</span><span class="n">get</span><span class="p">());</span>
<span class="n">LOG</span><span class="p">(</span><span class="n">INFO</span><span class="p">)</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="n">vector</span><span class="o">-&gt;</span><span class="n">toString</span><span class="p">();</span>

<span class="o">&gt;</span><span class="w"> </span><span class="p">[</span><span class="n">FLAT</span><span class="w"> </span><span class="n">VARCHAR</span><span class="o">:</span><span class="w"> </span><span class="mi">100</span><span class="w"> </span><span class="n">elements</span><span class="p">,</span><span class="w"> </span><span class="n">no</span><span class="w"> </span><span class="n">nulls</span><span class="p">]</span>
</pre></div>
</div>
<p>BaseVector::create() returns std::shared_ptr&lt;BaseVector&gt; (a.k.a. VectorPtr). If
we want a shared pointer to FlatVector&lt;StringView&gt; we can specify a template
parameter.</p>
<div class="highlight-c++ notranslate"><div class="highlight"><pre><span></span><span class="k">auto</span><span class="w"> </span><span class="n">vector</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">BaseVector</span><span class="o">::</span><span class="n">create</span><span class="o">&lt;</span><span class="n">FlatVector</span><span class="o">&lt;</span><span class="n">StringView</span><span class="o">&gt;&gt;</span><span class="p">(</span><span class="n">VARCHAR</span><span class="p">(),</span><span class="w"> </span><span class="mi">100</span><span class="p">,</span><span class="w"> </span><span class="n">pool</span><span class="p">.</span><span class="n">get</span><span class="p">());</span>
</pre></div>
</div>
<p>Now vector is an std::shared_ptr&lt;FlatVector&lt;StringView&gt;&gt;
(a.k.a. FlatVectorPtr&lt;StringView&gt;) and we can easily access methods defined
only for FlatVectors. For example, we can check the number of string buffers.</p>
<div class="highlight-c++ notranslate"><div class="highlight"><pre><span></span><span class="n">LOG</span><span class="p">(</span><span class="n">INFO</span><span class="p">)</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="n">vector</span><span class="o">-&gt;</span><span class="n">stringBuffers</span><span class="p">().</span><span class="n">size</span><span class="p">();</span>

<span class="o">&gt;</span><span class="w"> </span><span class="mi">0</span>
</pre></div>
</div>
<p>We don’t have any non-empty strings in the vector, so there are no string
buffers. Let’s write some strings.</p>
<div class="highlight-c++ notranslate"><div class="highlight"><pre><span></span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="k">auto</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="mi">100</span><span class="p">;</span><span class="w"> </span><span class="o">++</span><span class="n">i</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">i</span><span class="w"> </span><span class="o">%</span><span class="w"> </span><span class="mi">3</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">   </span><span class="n">vector</span><span class="o">-&gt;</span><span class="n">set</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;RED&quot;</span><span class="p">);</span>
<span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">i</span><span class="w"> </span><span class="o">%</span><span class="w"> </span><span class="mi">3</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">1</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">   </span><span class="n">vector</span><span class="o">-&gt;</span><span class="n">set</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;GREEN&quot;</span><span class="p">);</span>
<span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">i</span><span class="w"> </span><span class="o">%</span><span class="w"> </span><span class="mi">3</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">2</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">   </span><span class="n">vector</span><span class="o">-&gt;</span><span class="n">set</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;BLUE&quot;</span><span class="p">);</span>
<span class="w"> </span><span class="p">}</span>
<span class="p">}</span>

<span class="n">LOG</span><span class="p">(</span><span class="n">INFO</span><span class="p">)</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="s">&quot;Number of string buffers: &quot;</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="n">vector</span><span class="o">-&gt;</span><span class="n">stringBuffers</span><span class="p">().</span><span class="n">size</span><span class="p">();</span>
<span class="n">LOG</span><span class="p">(</span><span class="n">INFO</span><span class="p">)</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="n">vector</span><span class="o">-&gt;</span><span class="n">toString</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="mi">10</span><span class="p">);</span>

<span class="o">&gt;</span><span class="w"> </span><span class="n">Number</span><span class="w"> </span><span class="n">of</span><span class="w"> </span><span class="n">string</span><span class="w"> </span><span class="n">buffers</span><span class="o">:</span><span class="w"> </span><span class="mi">0</span>
<span class="o">&gt;</span><span class="w"> </span><span class="mi">0</span><span class="o">:</span><span class="w"> </span><span class="n">RED</span>
<span class="w">  </span><span class="mi">1</span><span class="o">:</span><span class="w"> </span><span class="n">GREEN</span>
<span class="w">  </span><span class="mi">2</span><span class="o">:</span><span class="w"> </span><span class="n">BLUE</span>
<span class="w">  </span><span class="mi">3</span><span class="o">:</span><span class="w"> </span><span class="n">RED</span>
<span class="w">  </span><span class="mi">4</span><span class="o">:</span><span class="w"> </span><span class="n">GREEN</span>
</pre></div>
</div>
<p>The vector now has non-empty strings, but still no string buffers. That’s
because we wrote only short strings (&lt;= 12 bytes each). These strings are fully
stored within the StringViews inside the values buffer and do not require
separate string buffers.</p>
<p>Let’s now write some long strings.</p>
<div class="highlight-c++ notranslate"><div class="highlight"><pre><span></span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="k">auto</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="mi">100</span><span class="p">;</span><span class="w"> </span><span class="o">++</span><span class="n">i</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">i</span><span class="w"> </span><span class="o">%</span><span class="w"> </span><span class="mi">3</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">   </span><span class="n">vector</span><span class="o">-&gt;</span><span class="n">set</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;In my hometown where I used to stay&quot;</span><span class="p">);</span>
<span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">i</span><span class="w"> </span><span class="o">%</span><span class="w"> </span><span class="mi">3</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">1</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">   </span><span class="n">vector</span><span class="o">-&gt;</span><span class="n">set</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;The name of the place is Augusta, GA&quot;</span><span class="p">);</span>
<span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">i</span><span class="w"> </span><span class="o">%</span><span class="w"> </span><span class="mi">3</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">2</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">   </span><span class="n">vector</span><span class="o">-&gt;</span><span class="n">set</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;Down there we have a good time&quot;</span><span class="p">);</span>
<span class="w"> </span><span class="p">}</span>
<span class="p">}</span>

<span class="n">LOG</span><span class="p">(</span><span class="n">INFO</span><span class="p">)</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="s">&quot;Number of string buffers: &quot;</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="n">vector</span><span class="o">-&gt;</span><span class="n">stringBuffers</span><span class="p">().</span><span class="n">size</span><span class="p">();</span>
<span class="n">LOG</span><span class="p">(</span><span class="n">INFO</span><span class="p">)</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="n">vector</span><span class="o">-&gt;</span><span class="n">toString</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="mi">10</span><span class="p">);</span>

<span class="o">&gt;</span><span class="w"> </span><span class="n">Number</span><span class="w"> </span><span class="n">of</span><span class="w"> </span><span class="n">string</span><span class="w"> </span><span class="n">buffers</span><span class="o">:</span><span class="w"> </span><span class="mi">1</span>
<span class="o">&gt;</span><span class="w"> </span><span class="mi">0</span><span class="o">:</span><span class="w"> </span><span class="n">In</span><span class="w"> </span><span class="n">my</span><span class="w"> </span><span class="n">hometown</span><span class="w"> </span><span class="n">where</span><span class="w"> </span><span class="n">I</span><span class="w"> </span><span class="n">used</span><span class="w"> </span><span class="n">to</span><span class="w"> </span><span class="n">stay</span>
<span class="w">  </span><span class="mi">1</span><span class="o">:</span><span class="w"> </span><span class="n">The</span><span class="w"> </span><span class="n">name</span><span class="w"> </span><span class="n">of</span><span class="w"> </span><span class="n">the</span><span class="w"> </span><span class="n">place</span><span class="w"> </span><span class="n">is</span><span class="w"> </span><span class="n">Augusta</span><span class="p">,</span><span class="w"> </span><span class="n">GA</span>
<span class="w">  </span><span class="mi">2</span><span class="o">:</span><span class="w"> </span><span class="n">Down</span><span class="w"> </span><span class="n">there</span><span class="w"> </span><span class="n">we</span><span class="w"> </span><span class="n">have</span><span class="w"> </span><span class="n">a</span><span class="w"> </span><span class="n">good</span><span class="w"> </span><span class="n">time</span>
<span class="w">  </span><span class="mi">3</span><span class="o">:</span><span class="w"> </span><span class="n">In</span><span class="w"> </span><span class="n">my</span><span class="w"> </span><span class="n">hometown</span><span class="w"> </span><span class="n">where</span><span class="w"> </span><span class="n">I</span><span class="w"> </span><span class="n">used</span><span class="w"> </span><span class="n">to</span><span class="w"> </span><span class="n">stay</span>
<span class="w">  </span><span class="mi">4</span><span class="o">:</span><span class="w"> </span><span class="n">The</span><span class="w"> </span><span class="n">name</span><span class="w"> </span><span class="n">of</span><span class="w"> </span><span class="n">the</span><span class="w"> </span><span class="n">place</span><span class="w"> </span><span class="n">is</span><span class="w"> </span><span class="n">Augusta</span><span class="p">,</span><span class="w"> </span><span class="n">GA</span>

<span class="k">const</span><span class="w"> </span><span class="k">auto</span><span class="o">&amp;</span><span class="w"> </span><span class="n">stringBuffer</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">vector</span><span class="o">-&gt;</span><span class="n">stringBuffers</span><span class="p">()[</span><span class="mi">0</span><span class="p">];</span>
<span class="n">LOG</span><span class="p">(</span><span class="n">INFO</span><span class="p">)</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="n">stringBuffer</span><span class="o">-&gt;</span><span class="n">size</span><span class="p">()</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="s">&quot;, &quot;</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="n">stringBuffer</span><span class="o">-&gt;</span><span class="n">capacity</span><span class="p">();</span>

<span class="o">&gt;</span><span class="w"> </span><span class="mi">3368</span><span class="p">,</span><span class="w"> </span><span class="mi">49056</span>

<span class="n">LOG</span><span class="p">(</span><span class="n">INFO</span><span class="p">)</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">string_view</span><span class="p">(</span><span class="n">stringBuffer</span><span class="o">-&gt;</span><span class="n">as</span><span class="o">&lt;</span><span class="kt">char</span><span class="o">&gt;</span><span class="p">(),</span><span class="w"> </span><span class="mi">100</span><span class="p">);</span>

<span class="o">&gt;</span><span class="w"> </span><span class="n">In</span><span class="w"> </span><span class="n">my</span><span class="w"> </span><span class="n">hometown</span><span class="w"> </span><span class="n">where</span><span class="w"> </span><span class="n">I</span><span class="w"> </span><span class="n">used</span><span class="w"> </span><span class="n">to</span><span class="w"> </span><span class="n">stayThe</span><span class="w"> </span><span class="n">name</span><span class="w"> </span><span class="n">of</span><span class="w"> </span><span class="n">the</span><span class="w"> </span><span class="n">place</span><span class="w"> </span><span class="n">is</span><span class="w"> </span><span class="n">Augusta</span><span class="p">,</span><span class="w"> </span><span class="n">GADown</span><span class="w"> </span><span class="n">there</span><span class="w"> </span><span class="n">we</span><span class="w"> </span><span class="n">have</span><span class="w"> </span><span class="n">a</span><span class="w"> </span><span class="n">good</span><span class="w"> </span><span class="n">tim</span>
</pre></div>
</div>
<p>Now, we see that there is one string buffer of size 3368 bytes and total
capacity of 49056 bytes. We can also see that this buffer contains the strings
we wrote one after another.</p>
<p>If we change some strings, the new strings will be written to the end of the
buffer and if we exceed the buffer’s capacity, a new buffer will be allocated.</p>
<div class="highlight-c++ notranslate"><div class="highlight"><pre><span></span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="k">auto</span><span class="w"> </span><span class="n">n</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">n</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="mi">25</span><span class="p">;</span><span class="w"> </span><span class="o">++</span><span class="n">n</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="k">auto</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="mi">100</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="mi">2</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="n">vector</span><span class="o">-&gt;</span><span class="n">set</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;We all get together in time, for rhythm then we do&quot;</span><span class="p">);</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="n">LOG</span><span class="p">(</span><span class="n">INFO</span><span class="p">)</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="n">n</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="s">&quot;: Number of string buffers: &quot;</span>
<span class="w">              </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="n">vector</span><span class="o">-&gt;</span><span class="n">stringBuffers</span><span class="p">().</span><span class="n">size</span><span class="p">();</span>

<span class="w">    </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="k">const</span><span class="w"> </span><span class="k">auto</span><span class="o">&amp;</span><span class="w"> </span><span class="n">buffer</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="n">vector</span><span class="o">-&gt;</span><span class="n">stringBuffers</span><span class="p">())</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="n">LOG</span><span class="p">(</span><span class="n">INFO</span><span class="p">)</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="n">buffer</span><span class="o">-&gt;</span><span class="n">size</span><span class="p">()</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="s">&quot;, &quot;</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="n">buffer</span><span class="o">-&gt;</span><span class="n">capacity</span><span class="p">();</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">}</span>

<span class="o">&gt;</span><span class="w"> </span><span class="mi">0</span><span class="o">:</span><span class="w"> </span><span class="n">Number</span><span class="w"> </span><span class="n">of</span><span class="w"> </span><span class="n">string</span><span class="w"> </span><span class="n">buffers</span><span class="o">:</span><span class="w"> </span><span class="mi">1</span>
<span class="o">&gt;</span><span class="w"> </span><span class="mi">5868</span><span class="p">,</span><span class="w"> </span><span class="mi">49056</span>
<span class="p">...</span>
<span class="o">&gt;</span><span class="w"> </span><span class="mi">17</span><span class="o">:</span><span class="w"> </span><span class="n">Number</span><span class="w"> </span><span class="n">of</span><span class="w"> </span><span class="n">string</span><span class="w"> </span><span class="n">buffers</span><span class="o">:</span><span class="w"> </span><span class="mi">1</span>
<span class="o">&gt;</span><span class="w"> </span><span class="mi">48368</span><span class="p">,</span><span class="w"> </span><span class="mi">49056</span>

<span class="o">&gt;</span><span class="w"> </span><span class="mi">18</span><span class="o">:</span><span class="w"> </span><span class="n">Number</span><span class="w"> </span><span class="n">of</span><span class="w"> </span><span class="n">string</span><span class="w"> </span><span class="n">buffers</span><span class="o">:</span><span class="w"> </span><span class="mi">2</span>
<span class="o">&gt;</span><span class="w"> </span><span class="mi">49018</span><span class="p">,</span><span class="w"> </span><span class="mi">49056</span>
<span class="o">&gt;</span><span class="w"> </span><span class="mi">1850</span><span class="p">,</span><span class="w"> </span><span class="mi">49056</span>
</pre></div>
</div>
<p>FlatVector&lt;StringView&gt;::set(index, value) method copies the string to the end of
a string buffer and updates StringView in the values buffer to point to that
copy. The old string is not removed and still occupies space in the buffer. We
need to be careful not to end up with many buffers full of unreferenced
strings. Also, FlatVector&lt;StringView&gt;::set doesn’t check if the “new” string
already exists. There is no de-duplication logic.</p>
<p>We can also provide our own string buffers and make StringViews that refer to
these. Let’s create a buffer to hold the 3 strings we used above, then fill in
vector with StringViews pointing to these strings.</p>
<div class="highlight-c++ notranslate"><div class="highlight"><pre><span></span><span class="k">const</span><span class="w"> </span><span class="kt">char</span><span class="o">*</span><span class="w"> </span><span class="n">s1</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;In my hometown where I used to stay&quot;</span><span class="p">;</span>
<span class="k">const</span><span class="w"> </span><span class="kt">char</span><span class="o">*</span><span class="w"> </span><span class="n">s2</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;The name of the place is Augusta, GA&quot;</span><span class="p">;</span>
<span class="k">const</span><span class="w"> </span><span class="kt">char</span><span class="o">*</span><span class="w"> </span><span class="n">s3</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;Down there we have a good time&quot;</span><span class="p">;</span>

<span class="n">BufferPtr</span><span class="w"> </span><span class="n">buffer</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">AlignedBuffer</span><span class="o">::</span><span class="n">allocate</span><span class="o">&lt;</span><span class="kt">char</span><span class="o">&gt;</span><span class="p">(</span><span class="mi">200</span><span class="p">,</span><span class="w"> </span><span class="n">pool</span><span class="p">.</span><span class="n">get</span><span class="p">());</span>
<span class="k">auto</span><span class="o">*</span><span class="w"> </span><span class="n">rawBuffer</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">buffer</span><span class="o">-&gt;</span><span class="n">asMutable</span><span class="o">&lt;</span><span class="kt">char</span><span class="o">&gt;</span><span class="p">();</span>

<span class="kt">int32_t</span><span class="w"> </span><span class="n">offset1</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
<span class="n">memcpy</span><span class="p">(</span><span class="n">rawBuffer</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">offset1</span><span class="p">,</span><span class="w"> </span><span class="n">s1</span><span class="p">,</span><span class="w"> </span><span class="n">strlen</span><span class="p">(</span><span class="n">s1</span><span class="p">));</span>

<span class="kt">int32_t</span><span class="w"> </span><span class="n">offset2</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">offset1</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">strlen</span><span class="p">(</span><span class="n">s1</span><span class="p">);</span>
<span class="n">memcpy</span><span class="p">(</span><span class="n">rawBuffer</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">offset2</span><span class="p">,</span><span class="w"> </span><span class="n">s2</span><span class="p">,</span><span class="w"> </span><span class="n">strlen</span><span class="p">(</span><span class="n">s2</span><span class="p">));</span>

<span class="kt">int32_t</span><span class="w"> </span><span class="n">offset3</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">offset2</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">strlen</span><span class="p">(</span><span class="n">s2</span><span class="p">);</span>
<span class="n">memcpy</span><span class="p">(</span><span class="n">rawBuffer</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">offset3</span><span class="p">,</span><span class="w"> </span><span class="n">s3</span><span class="p">,</span><span class="w"> </span><span class="n">strlen</span><span class="p">(</span><span class="n">s3</span><span class="p">));</span>
</pre></div>
</div>
<p>We have a string buffer. Let’s create a vector using that buffer. We will use
the FlatVector&lt;StringView&gt;::setStringBuffers() method.</p>
<div class="highlight-c++ notranslate"><div class="highlight"><pre><span></span><span class="k">auto</span><span class="w"> </span><span class="n">vector</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">BaseVector</span><span class="o">::</span><span class="n">create</span><span class="o">&lt;</span><span class="n">FlatVector</span><span class="o">&lt;</span><span class="n">StringView</span><span class="o">&gt;&gt;</span><span class="p">(</span><span class="n">VARCHAR</span><span class="p">(),</span><span class="w"> </span><span class="mi">100</span><span class="p">,</span><span class="w"> </span><span class="n">pool</span><span class="p">.</span><span class="n">get</span><span class="p">());</span>
<span class="n">vector</span><span class="o">-&gt;</span><span class="n">setStringBuffers</span><span class="p">({</span><span class="n">buffer</span><span class="p">});</span>

<span class="n">LOG</span><span class="p">(</span><span class="n">INFO</span><span class="p">)</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="s">&quot;Number of string buffers: &quot;</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="n">vector</span><span class="o">-&gt;</span><span class="n">stringBuffers</span><span class="p">().</span><span class="n">size</span><span class="p">();</span>

<span class="k">const</span><span class="w"> </span><span class="k">auto</span><span class="o">&amp;</span><span class="w"> </span><span class="n">stringBuffer</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">vector</span><span class="o">-&gt;</span><span class="n">stringBuffers</span><span class="p">()[</span><span class="mi">0</span><span class="p">];</span>
<span class="n">LOG</span><span class="p">(</span><span class="n">INFO</span><span class="p">)</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="n">stringBuffer</span><span class="o">-&gt;</span><span class="n">size</span><span class="p">()</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="s">&quot;, &quot;</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="n">stringBuffer</span><span class="o">-&gt;</span><span class="n">capacity</span><span class="p">();</span>

<span class="o">&gt;</span><span class="w"> </span><span class="n">Number</span><span class="w"> </span><span class="n">of</span><span class="w"> </span><span class="n">string</span><span class="w"> </span><span class="n">buffers</span><span class="o">:</span><span class="w"> </span><span class="mi">1</span>
<span class="o">&gt;</span><span class="w"> </span><span class="mi">200</span><span class="p">,</span><span class="w"> </span><span class="mi">288</span>

<span class="n">LOG</span><span class="p">(</span><span class="n">INFO</span><span class="p">)</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="n">vector</span><span class="o">-&gt;</span><span class="n">toString</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="mi">10</span><span class="p">);</span>

<span class="o">&gt;</span><span class="w"> </span><span class="mi">0</span><span class="o">:</span>
<span class="w">  </span><span class="mi">1</span><span class="o">:</span>
<span class="w">  </span><span class="mi">2</span><span class="o">:</span>
<span class="w">  </span><span class="mi">3</span><span class="o">:</span>
</pre></div>
</div>
<p>We have a vector with a string buffer, but all strings are still empty. Let’s
now populate the strings in the vector using StringViews that refer to the
string buffer. We are going to use the FlatVector&lt;StringView&gt;::setNoCopy method.</p>
<div class="highlight-c++ notranslate"><div class="highlight"><pre><span></span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="k">auto</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="mi">100</span><span class="p">;</span><span class="w"> </span><span class="o">++</span><span class="n">i</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">i</span><span class="w"> </span><span class="o">%</span><span class="w"> </span><span class="mi">3</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">   </span><span class="n">vector</span><span class="o">-&gt;</span><span class="n">setNoCopy</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="w"> </span><span class="n">StringView</span><span class="p">(</span><span class="n">rawBuffer</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">offset1</span><span class="p">,</span><span class="w"> </span><span class="n">strlen</span><span class="p">(</span><span class="n">s1</span><span class="p">)));</span>
<span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">i</span><span class="w"> </span><span class="o">%</span><span class="w"> </span><span class="mi">3</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">1</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">   </span><span class="n">vector</span><span class="o">-&gt;</span><span class="n">setNoCopy</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="w"> </span><span class="n">StringView</span><span class="p">(</span><span class="n">rawBuffer</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">offset2</span><span class="p">,</span><span class="w"> </span><span class="n">strlen</span><span class="p">(</span><span class="n">s2</span><span class="p">)));</span>
<span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">i</span><span class="w"> </span><span class="o">%</span><span class="w"> </span><span class="mi">3</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">2</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">   </span><span class="n">vector</span><span class="o">-&gt;</span><span class="n">setNoCopy</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="w"> </span><span class="n">StringView</span><span class="p">(</span><span class="n">rawBuffer</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">offset3</span><span class="p">,</span><span class="w"> </span><span class="n">strlen</span><span class="p">(</span><span class="n">s3</span><span class="p">)));</span>
<span class="w"> </span><span class="p">}</span>
<span class="p">}</span>

<span class="n">LOG</span><span class="p">(</span><span class="n">INFO</span><span class="p">)</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="s">&quot;Number of string buffers: &quot;</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="n">vector</span><span class="o">-&gt;</span><span class="n">stringBuffers</span><span class="p">().</span><span class="n">size</span><span class="p">();</span>

<span class="k">const</span><span class="w"> </span><span class="k">auto</span><span class="o">&amp;</span><span class="w"> </span><span class="n">stringBuffer</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">vector</span><span class="o">-&gt;</span><span class="n">stringBuffers</span><span class="p">()[</span><span class="mi">0</span><span class="p">];</span>
<span class="n">LOG</span><span class="p">(</span><span class="n">INFO</span><span class="p">)</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="n">stringBuffer</span><span class="o">-&gt;</span><span class="n">size</span><span class="p">()</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="s">&quot;, &quot;</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="n">stringBuffer</span><span class="o">-&gt;</span><span class="n">capacity</span><span class="p">();</span>

<span class="o">&gt;</span><span class="w"> </span><span class="n">Number</span><span class="w"> </span><span class="n">of</span><span class="w"> </span><span class="n">string</span><span class="w"> </span><span class="n">buffers</span><span class="o">:</span><span class="w"> </span><span class="mi">1</span>
<span class="o">&gt;</span><span class="w"> </span><span class="mi">200</span><span class="p">,</span><span class="w"> </span><span class="mi">288</span>

<span class="n">LOG</span><span class="p">(</span><span class="n">INFO</span><span class="p">)</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="n">vector</span><span class="o">-&gt;</span><span class="n">toString</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="mi">10</span><span class="p">);</span>

<span class="o">&gt;</span><span class="w"> </span><span class="mi">0</span><span class="o">:</span><span class="w"> </span><span class="n">In</span><span class="w"> </span><span class="n">my</span><span class="w"> </span><span class="n">hometown</span><span class="w"> </span><span class="n">where</span><span class="w"> </span><span class="n">I</span><span class="w"> </span><span class="n">used</span><span class="w"> </span><span class="n">to</span><span class="w"> </span><span class="n">stay</span>
<span class="w">  </span><span class="mi">1</span><span class="o">:</span><span class="w"> </span><span class="n">The</span><span class="w"> </span><span class="n">name</span><span class="w"> </span><span class="n">of</span><span class="w"> </span><span class="n">the</span><span class="w"> </span><span class="n">place</span><span class="w"> </span><span class="n">is</span><span class="w"> </span><span class="n">Augusta</span><span class="p">,</span><span class="w"> </span><span class="n">GA</span>
<span class="w">  </span><span class="mi">2</span><span class="o">:</span><span class="w"> </span><span class="n">Down</span><span class="w"> </span><span class="n">there</span><span class="w"> </span><span class="n">we</span><span class="w"> </span><span class="n">have</span><span class="w"> </span><span class="n">a</span><span class="w"> </span><span class="n">good</span><span class="w"> </span><span class="n">time</span>
<span class="w">  </span><span class="mi">3</span><span class="o">:</span><span class="w"> </span><span class="n">In</span><span class="w"> </span><span class="n">my</span><span class="w"> </span><span class="n">hometown</span><span class="w"> </span><span class="n">where</span><span class="w"> </span><span class="n">I</span><span class="w"> </span><span class="n">used</span><span class="w"> </span><span class="n">to</span><span class="w"> </span><span class="n">stay</span>
<span class="w">  </span><span class="mi">4</span><span class="o">:</span><span class="w"> </span><span class="n">The</span><span class="w"> </span><span class="n">name</span><span class="w"> </span><span class="n">of</span><span class="w"> </span><span class="n">the</span><span class="w"> </span><span class="n">place</span><span class="w"> </span><span class="n">is</span><span class="w"> </span><span class="n">Augusta</span><span class="p">,</span><span class="w"> </span><span class="n">GA</span>
</pre></div>
</div>
<p>The setNoCopy method takes a StringView and copies it into the values buffer. It
assumes that StringView is either inline (represents a short string) or points
to a valid location in one of the string buffers.</p>
<p>This design enables many zero-copy optimizations. For example, we can create a
new vector of sub-strings without copying any string. Let’s say we have a
vector of strings and we want to create a vector of substrings starting at
first character and going for up to 20 bytes.</p>
<div class="highlight-c++ notranslate"><div class="highlight"><pre><span></span><span class="k">auto</span><span class="w"> </span><span class="n">substr</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">BaseVector</span><span class="o">::</span><span class="n">create</span><span class="o">&lt;</span><span class="n">FlatVector</span><span class="o">&lt;</span><span class="n">StringView</span><span class="o">&gt;&gt;</span><span class="p">(</span><span class="n">VARCHAR</span><span class="p">(),</span><span class="w"> </span><span class="mi">100</span><span class="p">,</span><span class="w"> </span><span class="n">pool</span><span class="p">.</span><span class="n">get</span><span class="p">());</span>
<span class="n">substr</span><span class="o">-&gt;</span><span class="n">acquireSharedStringBuffers</span><span class="p">(</span><span class="n">vector</span><span class="p">.</span><span class="n">get</span><span class="p">());</span>
</pre></div>
</div>
<p>We created a new string vector and used acquireSharedStringBuffers method to
copy smart pointers for the string buffers from the original vector into this
new vector.</p>
<p>We can now populate the strings using the setNoCopy method.</p>
<div class="highlight-c++ notranslate"><div class="highlight"><pre><span></span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="k">auto</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="mi">100</span><span class="p">;</span><span class="w"> </span><span class="o">++</span><span class="n">i</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w"> </span><span class="n">substr</span><span class="o">-&gt;</span><span class="n">setNoCopy</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="w"> </span><span class="n">StringView</span><span class="p">(</span><span class="n">vector</span><span class="o">-&gt;</span><span class="n">valueAt</span><span class="p">(</span><span class="n">i</span><span class="p">).</span><span class="n">data</span><span class="p">(),</span><span class="w"> </span><span class="mi">20</span><span class="p">));</span>
<span class="p">}</span>

<span class="n">LOG</span><span class="p">(</span><span class="n">INFO</span><span class="p">)</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="n">substr</span><span class="o">-&gt;</span><span class="n">toString</span><span class="p">();</span>
<span class="n">LOG</span><span class="p">(</span><span class="n">INFO</span><span class="p">)</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="n">substr</span><span class="o">-&gt;</span><span class="n">toString</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="mi">10</span><span class="p">);</span>

<span class="o">&gt;</span><span class="w"> </span><span class="mi">0</span><span class="o">:</span><span class="w"> </span><span class="n">In</span><span class="w"> </span><span class="n">my</span><span class="w"> </span><span class="n">hometown</span><span class="w"> </span><span class="n">where</span><span class="w"> </span><span class="n">I</span><span class="w"> </span><span class="n">used</span><span class="w"> </span><span class="n">to</span><span class="w"> </span><span class="n">stay</span>
<span class="w">  </span><span class="mi">1</span><span class="o">:</span><span class="w"> </span><span class="n">The</span><span class="w"> </span><span class="n">name</span><span class="w"> </span><span class="n">of</span><span class="w"> </span><span class="n">the</span><span class="w"> </span><span class="n">place</span><span class="w"> </span><span class="n">is</span><span class="w"> </span><span class="n">Augusta</span><span class="p">,</span><span class="w"> </span><span class="n">GA</span>
<span class="w">  </span><span class="mi">2</span><span class="o">:</span><span class="w"> </span><span class="n">Down</span><span class="w"> </span><span class="n">there</span><span class="w"> </span><span class="n">we</span><span class="w"> </span><span class="n">have</span><span class="w"> </span><span class="n">a</span><span class="w"> </span><span class="n">good</span><span class="w"> </span><span class="n">time</span>
<span class="w">  </span><span class="mi">3</span><span class="o">:</span><span class="w"> </span><span class="n">In</span><span class="w"> </span><span class="n">my</span><span class="w"> </span><span class="n">hometown</span><span class="w"> </span><span class="n">where</span><span class="w"> </span><span class="n">I</span><span class="w"> </span><span class="n">used</span><span class="w"> </span><span class="n">to</span><span class="w"> </span><span class="n">stay</span>
<span class="w">  </span><span class="mi">4</span><span class="o">:</span><span class="w"> </span><span class="n">The</span><span class="w"> </span><span class="n">name</span><span class="w"> </span><span class="n">of</span><span class="w"> </span><span class="n">the</span><span class="w"> </span><span class="n">place</span><span class="w"> </span><span class="n">is</span><span class="w"> </span><span class="n">Augusta</span><span class="p">,</span><span class="w"> </span><span class="n">GA</span>
</pre></div>
</div>
<p>And verify that the new vector has only one string buffer and it is the same
buffer as in the original vector.</p>
<div class="highlight-c++ notranslate"><div class="highlight"><pre><span></span><span class="n">LOG</span><span class="p">(</span><span class="n">INFO</span><span class="p">)</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="n">substr</span><span class="o">-&gt;</span><span class="n">stringBuffers</span><span class="p">().</span><span class="n">size</span><span class="p">();</span>
<span class="n">LOG</span><span class="p">(</span><span class="n">INFO</span><span class="p">)</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="p">(</span><span class="kt">void</span><span class="o">*</span><span class="p">)</span><span class="n">substr</span><span class="o">-&gt;</span><span class="n">stringBuffers</span><span class="p">()[</span><span class="mi">0</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">as</span><span class="o">&lt;</span><span class="kt">char</span><span class="o">&gt;</span><span class="p">();</span>
<span class="n">LOG</span><span class="p">(</span><span class="n">INFO</span><span class="p">)</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="p">(</span><span class="kt">void</span><span class="o">*</span><span class="p">)</span><span class="n">vector</span><span class="o">-&gt;</span><span class="n">stringBuffers</span><span class="p">()[</span><span class="mi">0</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">as</span><span class="o">&lt;</span><span class="kt">char</span><span class="o">&gt;</span><span class="p">();</span>

<span class="o">&gt;</span><span class="w"> </span><span class="mi">1</span>
<span class="o">&gt;</span><span class="w"> </span><span class="mh">0x7fa1c011b400</span>
<span class="o">&gt;</span><span class="w"> </span><span class="mh">0x7fa1c011b400</span>
</pre></div>
</div>
<p>In this chapter we have learned how to create string vectors. In the next
chapter we’ll look into how to create vectors of arrays.</p>
</section>


            <div class="clearer"></div>
          </div>
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
  <div>
    <h4>Previous topic</h4>
    <p class="topless"><a href="chapter01.html"
                          title="previous chapter">Chapter 1: Buffers and Flat Vectors</a></p>
  </div>
  <div role="note" aria-label="source link">
    <h3>This Page</h3>
    <ul class="this-page-menu">
      <li><a href="../_sources/programming-guide/chapter02.rst.txt"
            rel="nofollow">Show Source</a></li>
    </ul>
   </div>
<div id="searchbox" style="display: none" role="search">
  <h3 id="searchlabel">Quick search</h3>
    <div class="searchformwrapper">
    <form class="search" action="../search.html" method="get">
      <input type="text" name="q" aria-labelledby="searchlabel" autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false"/>
      <input type="submit" value="Go" />
    </form>
    </div>
</div>
<script>document.getElementById('searchbox').style.display = "block"</script>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../genindex.html" title="General Index"
             >index</a></li>
        <li class="right" >
          <a href="chapter01.html" title="Chapter 1: Buffers and Flat Vectors"
             >previous</a> |</li>
        <li class="nav-item nav-item-0"><a href="../index.html">Velox  documentation</a> &#187;</li>
          <li class="nav-item nav-item-1"><a href="../programming-guide.html" >Programming Guide</a> &#187;</li>
        <li class="nav-item nav-item-this"><a href="">Chapter 2: Flat Vectors of Strings</a></li> 
      </ul>
    </div>
    <div class="footer" role="contentinfo">
        &#169; Copyright TBD.
      Created using <a href="https://www.sphinx-doc.org/">Sphinx</a> 6.2.0.
    </div>
  </body>
</html>